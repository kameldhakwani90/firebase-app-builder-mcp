<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Firebase App Builder - Interface Avanc√©e</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Configuration initiale */
        .config-section {
            display: none;
        }

        .config-section.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-3px);
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-online { color: #4CAF50; }
        .status-offline { color: #f44336; }
        .status-waiting { color: #FF9800; }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border-radius: 12px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Confirmations Claude */
        .confirmation-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .confirmation-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        /* Token Status */
        .token-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .token-status.available {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .token-status.exhausted {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .token-status.scheduled {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        /* Logs */
        .logs-container {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 15px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            max-height: 250px;
            overflow-y: auto;
            line-height: 1.4;
            font-size: 13px;
        }

        .log-line {
            margin-bottom: 3px;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                order: -1;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #FF9800; }
        .notification.info { background: #2196F3; }

        .hidden { display: none; }

        /* Projets Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .project-card.running {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }

        .project-card.completed {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.05);
        }

        .project-card.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.05);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .project-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .project-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-running { background: #4CAF50; color: white; }
        .status-completed { background: #2196F3; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-paused { background: #FF9800; color: white; }
        .status-started { background: #9C27B0; color: white; }

        .project-info {
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .project-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Animations */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üî• Firebase App Builder</h1>
            <p>Interface Avanc√©e - Configuration & Suivi Temps R√©el</p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Gestion des Projets -->
                <div class="card config-section active" id="projects-management">
                    <h2>üìÇ Gestion des Projets</h2>
                    
                    <!-- Projets Existants -->
                    <div id="existing-projects">
                        <h3 style="margin-bottom: 15px;">üîÑ Projets Existants</h3>
                        <div id="projects-list" class="projects-grid">
                            <div style="text-align: center; padding: 20px; color: #666;">
                                üîç Chargement des projets...
                            </div>
                        </div>
                    </div>

                    <!-- Agent Actuel -->
                    <div id="current-agent" class="hidden" style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                        <h4 style="margin-bottom: 10px;">ü§ñ Agent Actuel</h4>
                        <div id="current-agent-info">
                            <p><strong>Projet:</strong> <span id="current-project-name">-</span></p>
                            <p><strong>√âtape:</strong> <span id="current-project-step">-</span></p>
                            <p><strong>Statut:</strong> <span id="current-project-status">-</span></p>
                        </div>
                        <div class="button-group" style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="stopCurrentAgent()">
                                ‚èπÔ∏è Arr√™ter
                            </button>
                            <button class="btn btn-secondary" onclick="viewCurrentProgress()">
                                üìä Voir Progression
                            </button>
                        </div>
                    </div>

                    <!-- Actions Projets -->
                    <div class="button-group" style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="showNewProjectForm()">
                            ‚ûï Nouveau Projet
                        </button>
                        <button class="btn btn-secondary" onclick="refreshProjects()">
                            üîÑ Actualiser
                        </button>
                    </div>
                </div>

                <!-- Configuration Nouveau Projet -->
                <div class="card config-section" id="new-project-config">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>‚öôÔ∏è Configuration Nouveau Projet</h2>
                        <button class="btn btn-secondary" onclick="backToProjectsManagement()">
                            ‚Üê Retour aux Projets
                        </button>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="github-url">üîó URL du Repository GitHub</label>
                        <input type="url" id="github-url" placeholder="https://github.com/user/my-project" required>
                    </div>

                    <h3 style="margin: 20px 0 15px 0;">üóÑÔ∏è Base de Donn√©es PostgreSQL</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="db-host">H√¥te</label>
                            <input type="text" id="db-host" value="localhost" placeholder="localhost">
                        </div>
                        <div class="form-group">
                            <label for="db-port">Port</label>
                            <input type="number" id="db-port" value="5432" placeholder="5432">
                        </div>
                        <div class="form-group">
                            <label for="db-username">Utilisateur</label>
                            <input type="text" id="db-username" value="postgres" placeholder="postgres">
                        </div>
                        <div class="form-group">
                            <label for="db-password">Mot de passe</label>
                            <input type="password" id="db-password" placeholder="Mot de passe" required>
                        </div>
                        <div class="form-group">
                            <label for="db-name">Base de donn√©es</label>
                            <input type="text" id="db-name" placeholder="mon_projet_db" required>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 15px 0;">üë§ Super Administrateur (Optionnel)</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="admin-name">Nom complet</label>
                            <input type="text" id="admin-name" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="admin-email">Email</label>
                            <input type="email" id="admin-email" placeholder="admin@monprojet.com">
                        </div>
                        <div class="form-group">
                            <label for="admin-password">Mot de passe</label>
                            <input type="password" id="admin-password" placeholder="Mot de passe s√©curis√©">
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="testDatabaseConnection()">
                            üîç Tester la connexion DB
                        </button>
                        <button class="btn btn-primary" onclick="startMigration()">
                            üöÄ D√©marrer la Migration
                        </button>
                    </div>
                </div>

                <!-- Progression -->
                <div class="card config-section" id="progress-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üìà Progression de la Migration</h2>
                        <button class="btn btn-secondary" onclick="backToProjectsManagement()">
                            ‚Üê Retour aux Projets
                        </button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress" style="width: 0%">0%</div>
                    </div>
                    <p id="progress-text">En attente de configuration...</p>
                    
                    <div class="status-grid" style="margin-top: 20px;">
                        <div class="status-card">
                            <h4>üìä Statut</h4>
                            <div class="status-value" id="status">Configuration</div>
                        </div>
                        <div class="status-card">
                            <h4>üîÑ √âtape</h4>
                            <div class="status-value" id="step">Initialisation</div>
                        </div>
                        <div class="status-card">
                            <h4>‚è±Ô∏è Dur√©e</h4>
                            <div class="status-value" id="duration">-</div>
                        </div>
                    </div>
                </div>

                <!-- Confirmations Claude -->
                <div class="card config-section" id="confirmations-section">
                    <h2>ü§ñ Confirmations Claude Code</h2>
                    <div id="confirmations-list">
                        <p style="color: #666; text-align: center; padding: 20px;">
                            Aucune confirmation en attente
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Mise √† Jour & Configuration -->
                <div class="card">
                    <h2>üîß Configuration Syst√®me</h2>
                    
                    <!-- Version & Mise √† jour -->
                    <div id="version-info" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Version:</strong> <span id="current-version">2.5.0</span>
                                <div id="update-status" style="margin-top: 5px; font-size: 0.9em;">
                                    <span id="update-text" class="text-info">V√©rification...</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="checkForUpdates()" id="check-update-btn">
                                üîç V√©rifier
                            </button>
                        </div>
                    </div>

                    <!-- Mise √† jour disponible -->
                    <div id="update-available" class="hidden" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">üöÄ Mise √† jour disponible !</h4>
                        <p><strong>Nouvelle version:</strong> <span id="latest-version">-</span></p>
                        <div class="button-group" style="margin-top: 10px;">
                            <button class="btn btn-primary btn-small" onclick="updateAgent()">
                                üì• Mettre √† jour
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="dismissUpdate()">
                                ‚è≠Ô∏è Plus tard
                            </button>
                        </div>
                    </div>

                    <!-- Configuration Port -->
                    <div style="margin-bottom: 20px;">
                        <h4>üåê Configuration Port Web</h4>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                            <select id="port-selector" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="3000">3000</option>
                                <option value="3001">3001</option>
                                <option value="3002" selected>3002</option>
                                <option value="3003">3003</option>
                                <option value="8000">8000</option>
                                <option value="8080">8080</option>
                            </select>
                            <button class="btn btn-secondary btn-small" onclick="changePort()">
                                üîÑ Changer
                            </button>
                        </div>
                        <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            Port actuel: <span id="current-port">3002</span>
                        </p>
                    </div>

                    <!-- Dossiers syst√®me -->
                    <div style="margin-bottom: 20px;">
                        <h4>üìÇ Dossiers Syst√®me</h4>
                        <div style="font-size: 0.9em; line-height: 1.6;">
                            <div style="margin: 8px 0;">
                                <strong>Projets:</strong> 
                                <a href="#" onclick="openFolder('projects')" style="color: #2196F3; text-decoration: none;">
                                    C:/Users/util01/firebase-migrations/
                                </a>
                            </div>
                            <div style="margin: 8px 0;">
                                <strong>Agent:</strong> 
                                <a href="#" onclick="openFolder('agent')" style="color: #2196F3; text-decoration: none;">
                                    C:/Users/util01/firebase-app-builder-mcp/
                                </a>
                            </div>
                            <div style="margin: 8px 0;">
                                <strong>Logs:</strong> 
                                <a href="#" onclick="openFolder('logs')" style="color: #2196F3; text-decoration: none;">
                                    C:/Users/util01/firebase-migrations/logs/
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Commandes MCP -->
                    <div style="margin-bottom: 20px;">
                        <h4>‚ö° Commandes Claude Code</h4>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em;">
                            <div style="margin-bottom: 8px;">
                                <strong>/migrate</strong> https://github.com/user/repo
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>/continue</strong> nom_projet
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>/projects</strong> (lister tous)
                            </div>
                            <div>
                                <strong>/status</strong> nom_projet
                            </div>
                        </div>
                        <p style="font-size: 0.8em; color: #666; margin-top: 8px;">
                            Utilisez ces commandes directement dans Claude Code avec "/"
                        </p>
                    </div>
                </div>

                <!-- Token Status -->
                <div class="card">
                    <h2>üéØ Gestion des Tokens Claude</h2>
                    <div class="token-status available" id="token-status">
                        <strong>‚úÖ Tokens Disponibles</strong>
                        <p>Pr√™t pour la migration</p>
                    </div>
                    
                    <div id="schedule-section" class="hidden">
                        <h4>‚è∞ Programmer une Reprise</h4>
                        <div class="form-group" style="margin: 10px 0;">
                            <label for="resume-time">Heure de reprise</label>
                            <input type="datetime-local" id="resume-time">
                        </div>
                        <div class="form-group" style="margin: 10px 0;">
                            <label for="resume-reason">Raison</label>
                            <select id="resume-reason">
                                <option value="tokens-exhausted">Tokens √©puis√©s</option>
                                <option value="manual-pause">Pause manuelle</option>
                                <option value="error-recovery">R√©cup√©ration d'erreur</option>
                                <option value="scheduled-maintenance">Maintenance programm√©e</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="scheduleResume()">
                            ‚è∞ Programmer
                        </button>
                    </div>

                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="checkTokenStatus()" id="check-tokens-btn">
                            üîç V√©rifier Tokens
                        </button>
                        <button class="btn btn-warning hidden" onclick="showScheduleSection()" id="schedule-btn">
                            ‚è∞ Programmer Reprise
                        </button>
                        <button class="btn btn-primary hidden" onclick="resumeNow()" id="resume-btn">
                            ‚ñ∂Ô∏è Reprendre Maintenant
                        </button>
                    </div>
                </div>

                <!-- Logs Temps R√©el -->
                <div class="card">
                    <h2>üìù Logs Temps R√©el</h2>
                    <div class="logs-container" id="logs">
                        <div class="log-line">üöÄ Interface Web initialis√©e</div>
                        <div class="log-line">‚è≥ En attente de configuration...</div>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="clearLogs()">
                            üóëÔ∏è Vider
                        </button>
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            üíæ Exporter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        let ws = null;
        let currentProject = null;
        let pendingConfirmations = new Map();
        
        // √âtat de l'application
        const appState = {
            configured: false,
            running: false,
            tokensAvailable: true,
            scheduledResume: null,
            projects: [],
            currentAgent: null
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Interface Web avanc√©e charg√©e');
            connectWebSocket();
            loadProjects();
            loadSystemConfig();
            checkForUpdates();
            
            // Pr√©remplir la date de reprise (dans 6 heures par d√©faut)
            const futureTime = new Date();
            futureTime.setHours(futureTime.getHours() + 6);
            document.getElementById('resume-time').value = futureTime.toISOString().slice(0, 16);
        });

        // WebSocket Connection
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:3000');
                
                ws.onopen = function() {
                    addLog('‚úÖ Connexion WebSocket √©tablie');
                    ws.send(JSON.stringify({ type: 'request-status' }));
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onclose = function() {
                    addLog('‚ùå Connexion WebSocket ferm√©e');
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    addLog('‚ùå Erreur WebSocket');
                };
            } catch (error) {
                addLog('‚ùå Impossible de se connecter au serveur');
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'status-update':
                    updateStatus(data.data);
                    break;
                    
                case 'claude-confirmation-request':
                    showClaudeConfirmation(data);
                    break;
                    
                case 'tokens-exhausted':
                    handleTokensExhausted(data.data);
                    break;
                    
                case 'auto-resume-triggered':
                    handleAutoResume(data.data);
                    break;
                    
                case 'project-config-received':
                    showNotification('Configuration sauvegard√©e !', 'success');
                    switchToProgressView();
                    break;
                    
                default:
                    console.log('Message non g√©r√©:', data);
            }
        }

        // Configuration Functions
        function testDatabaseConnection() {
            const config = getDatabaseConfig();
            
            if (!config.password) {
                showNotification('Mot de passe requis pour tester la connexion', 'error');
                return;
            }
            
            addLog('üîç Test de connexion PostgreSQL...');
            showNotification('Test de connexion en cours...', 'info');
            
            fetch('/api/postgres-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('‚úÖ Demande de test envoy√©e');
                }
            })
            .catch(error => {
                showNotification('Erreur lors du test', 'error');
                addLog('‚ùå Erreur test connexion: ' + error.message);
            });
        }

        function startMigration() {
            const githubUrl = document.getElementById('github-url').value;
            const dbConfig = getDatabaseConfig();
            const adminConfig = getAdminConfig();
            
            // Validation
            if (!githubUrl) {
                showNotification('URL GitHub requise', 'error');
                return;
            }
            
            if (!dbConfig.password || !dbConfig.database) {
                showNotification('Configuration base de donn√©es incompl√®te', 'error');
                return;
            }
            
            const projectConfig = {
                githubUrl: githubUrl,
                database: dbConfig,
                superAdmin: adminConfig.email ? adminConfig : null
            };
            
            addLog('üöÄ D√©marrage de la migration...');
            addLog('üìÇ Projet: ' + githubUrl);
            
            fetch('/api/project-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectConfig)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appState.configured = true;
                    currentProject = projectConfig;
                    addLog('‚úÖ Configuration envoy√©e √† l\'agent');
                } else {
                    showNotification('Erreur: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('Erreur de communication', 'error');
                addLog('‚ùå Erreur: ' + error.message);
            });
        }

        function getDatabaseConfig() {
            return {
                host: document.getElementById('db-host').value,
                port: parseInt(document.getElementById('db-port').value),
                username: document.getElementById('db-username').value,
                password: document.getElementById('db-password').value,
                database: document.getElementById('db-name').value
            };
        }

        function getAdminConfig() {
            return {
                name: document.getElementById('admin-name').value,
                email: document.getElementById('admin-email').value,
                password: document.getElementById('admin-password').value
            };
        }

        // UI Functions
        function switchToProgressView() {
            document.getElementById('initial-config').classList.remove('active');
            document.getElementById('progress-section').classList.add('active');
            document.getElementById('confirmations-section').classList.add('active');
        }

        function updateStatus(status) {
            // Mise √† jour du statut
            const statusEl = document.getElementById('status');
            const stepEl = document.getElementById('step');
            const durationEl = document.getElementById('duration');
            
            if (status.isRunning) {
                statusEl.textContent = 'En cours';
                statusEl.className = 'status-value status-online';
                appState.running = true;
            } else {
                statusEl.textContent = 'Inactif';
                statusEl.className = 'status-value status-offline';
                appState.running = false;
            }
            
            stepEl.textContent = status.currentStep || 'Attente';
            durationEl.textContent = status.duration ? formatDuration(status.duration) : '-';
            
            // Mise √† jour de la progression
            const progress = estimateProgress(status.currentStep);
            updateProgress(progress);
        }

        function updateProgress(percent) {
            const progressFill = document.getElementById('progress');
            const progressText = document.getElementById('progress-text');
            
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            
            if (percent === 0) {
                progressText.textContent = 'En attente de d√©marrage...';
            } else if (percent < 25) {
                progressText.textContent = 'Analyse du projet...';
            } else if (percent < 50) {
                progressText.textContent = 'G√©n√©ration de la base de donn√©es...';
            } else if (percent < 75) {
                progressText.textContent = 'Cr√©ation des APIs...';
            } else if (percent < 100) {
                progressText.textContent = 'Tests et finalisation...';
            } else {
                progressText.textContent = 'Migration termin√©e !';
                showNotification('Migration termin√©e avec succ√®s !', 'success');
            }
        }

        function estimateProgress(step) {
            const steps = {
                'initialization': 5,
                'analysis': 15,
                'super-workflow': 35,
                'database': 50,
                'api': 70,
                'tests': 85,
                'finalization': 100
            };
            
            return steps[step] || 0;
        }

        // Claude Confirmations
        function showClaudeConfirmation(data) {
            const confirmationsList = document.getElementById('confirmations-list');
            
            // Supprimer le message "aucune confirmation"
            if (confirmationsList.children.length === 1 && confirmationsList.children[0].tagName === 'P') {
                confirmationsList.innerHTML = '';
            }
            
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'confirmation-item';
            confirmationDiv.innerHTML = `
                <h4>ü§ñ Demande de Claude Code</h4>
                <p><strong>Type:</strong> ${data.type}</p>
                <p><strong>Message:</strong> ${data.message}</p>
                <div class="confirmation-actions">
                    <button class="btn btn-primary" onclick="confirmClaude('${data.requestId}', true)">
                        ‚úÖ Confirmer
                    </button>
                    <button class="btn btn-danger" onclick="confirmClaude('${data.requestId}', false)">
                        ‚ùå Refuser
                    </button>
                    <input type="text" placeholder="R√©ponse personnalis√©e (optionnel)" 
                           id="response-${data.requestId}" style="margin-left: 10px; padding: 8px;">
                </div>
            `;
            
            confirmationsList.appendChild(confirmationDiv);
            pendingConfirmations.set(data.requestId, data);
            
            addLog('ü§ñ Nouvelle demande de confirmation Claude Code');
            showNotification('Confirmation Claude Code requise', 'warning');
        }

        function confirmClaude(requestId, confirmed) {
            const responseInput = document.getElementById(`response-${requestId}`);
            const customResponse = responseInput ? responseInput.value : '';
            
            fetch('/api/claude-confirmation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requestId: requestId,
                    confirmed: confirmed,
                    response: customResponse
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Supprimer la confirmation de l'interface
                    const confirmationItem = document.querySelector(`button[onclick*="${requestId}"]`).closest('.confirmation-item');
                    confirmationItem.remove();
                    
                    pendingConfirmations.delete(requestId);
                    
                    // V√©rifier s'il n'y a plus de confirmations
                    const confirmationsList = document.getElementById('confirmations-list');
                    if (confirmationsList.children.length === 0) {
                        confirmationsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Aucune confirmation en attente</p>';
                    }
                    
                    const action = confirmed ? 'confirm√©e' : 'refus√©e';
                    addLog(`‚úÖ Demande Claude Code ${action}`);
                    showNotification(`Demande ${action}`, 'success');
                }
            })
            .catch(error => {
                showNotification('Erreur lors de la confirmation', 'error');
                addLog('‚ùå Erreur confirmation: ' + error.message);
            });
        }

        // Token Management
        function checkTokenStatus() {
            addLog('üîç V√©rification du statut des tokens...');
            
            // Simulation - √† remplacer par vraie v√©rification
            setTimeout(() => {
                const tokensOk = Math.random() > 0.3; // 70% de chance d'avoir des tokens
                
                if (tokensOk) {
                    updateTokenStatus('available', 'Tokens disponibles');
                } else {
                    updateTokenStatus('exhausted', 'Tokens √©puis√©s - Reprise dans 6h recommand√©e');
                }
            }, 1000);
        }

        function updateTokenStatus(status, message) {
            const tokenStatusEl = document.getElementById('token-status');
            const scheduleBtnEl = document.getElementById('schedule-btn');
            const resumeBtnEl = document.getElementById('resume-btn');
            
            appState.tokensAvailable = (status === 'available');
            
            if (status === 'available') {
                tokenStatusEl.className = 'token-status available';
                tokenStatusEl.innerHTML = `<strong>‚úÖ Tokens Disponibles</strong><p>${message}</p>`;
                scheduleBtnEl.classList.add('hidden');
                resumeBtnEl.classList.add('hidden');
            } else if (status === 'exhausted') {
                tokenStatusEl.className = 'token-status exhausted';
                tokenStatusEl.innerHTML = `<strong>‚ùå Tokens √âpuis√©s</strong><p>${message}</p>`;
                scheduleBtnEl.classList.remove('hidden');
                resumeBtnEl.classList.add('hidden');
            } else if (status === 'scheduled') {
                tokenStatusEl.className = 'token-status scheduled';
                tokenStatusEl.innerHTML = `<strong>‚è∞ Reprise Programm√©e</strong><p>${message}</p>`;
                scheduleBtnEl.classList.add('hidden');
                resumeBtnEl.classList.remove('hidden');
            }
            
            addLog(`üéØ Statut tokens: ${message}`);
        }

        function handleTokensExhausted(data) {
            updateTokenStatus('exhausted', data.message);
            showNotification('Tokens Claude Code √©puis√©s', 'warning');
            
            if (data.suggestedResumeTime) {
                const resumeTime = new Date(data.suggestedResumeTime);
                document.getElementById('resume-time').value = resumeTime.toISOString().slice(0, 16);
            }
        }

        function showScheduleSection() {
            document.getElementById('schedule-section').classList.remove('hidden');
        }

        function scheduleResume() {
            const resumeTime = document.getElementById('resume-time').value;
            const reason = document.getElementById('resume-reason').value;
            
            if (!resumeTime) {
                showNotification('Heure de reprise requise', 'error');
                return;
            }
            
            fetch('/api/schedule-resume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    resumeTime: resumeTime,
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resumeDate = new Date(resumeTime);
                    updateTokenStatus('scheduled', `Reprise pr√©vue: ${resumeDate.toLocaleString()}`);
                    document.getElementById('schedule-section').classList.add('hidden');
                    appState.scheduledResume = resumeTime;
                    
                    showNotification('Reprise programm√©e avec succ√®s', 'success');
                    addLog(`‚è∞ Reprise programm√©e pour ${resumeDate.toLocaleString()}`);
                }
            })
            .catch(error => {
                showNotification('Erreur lors de la programmation', 'error');
                addLog('‚ùå Erreur programmation: ' + error.message);
            });
        }

        function resumeNow() {
            if (confirm('Reprendre la migration maintenant ?')) {
                addLog('‚ñ∂Ô∏è Reprise manuelle d√©clench√©e');
                showNotification('Reprise de la migration...', 'info');
                
                // D√©clencher la reprise
                fetch('/api/manual-resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ manual: true })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTokenStatus('available', 'Migration reprise');
                        appState.scheduledResume = null;
                    }
                })
                .catch(error => {
                    showNotification('Erreur lors de la reprise', 'error');
                });
            }
        }

        function handleAutoResume(data) {
            addLog('üîÑ Reprise automatique d√©clench√©e');
            showNotification('Reprise automatique de la migration', 'success');
            updateTokenStatus('available', 'Migration reprise automatiquement');
            appState.scheduledResume = null;
        }

        // Logs Functions
        function addLog(message) {
            const logsContainer = document.getElementById('logs');
            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            logLine.textContent = `${new Date().toLocaleTimeString()} ${message}`;
            
            logsContainer.appendChild(logLine);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Limiter √† 100 lignes
            while (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('üóëÔ∏è Logs vid√©s');
        }

        function exportLogs() {
            const logs = Array.from(document.getElementById('logs').children)
                .map(line => line.textContent)
                .join('\n');
                
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-agent-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Logs export√©s', 'success');
        }

        // ===== GESTION DES PROJETS =====
        
        function loadProjects() {
            addLog('üìÇ Chargement des projets...');
            
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        appState.projects = data.projects || [];
                        appState.currentAgent = data.currentAgent;
                        renderProjects();
                        updateCurrentAgent();
                        addLog(`‚úÖ ${appState.projects.length} projet(s) charg√©(s)`);
                    }
                })
                .catch(error => {
                    addLog(`‚ùå Erreur chargement projets: ${error.message}`);
                    showNotification('Erreur lors du chargement des projets', 'error');
                });
        }

        function renderProjects() {
            const projectsList = document.getElementById('projects-list');
            
            if (appState.projects.length === 0) {
                projectsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        üì≠ Aucun projet trouv√©
                        <p style="margin-top: 10px; font-size: 0.9em;">Cr√©ez votre premier projet !</p>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = appState.projects.map(project => {
                const isRunning = appState.currentAgent && appState.currentAgent.projectName === project.name;
                const statusClass = getProjectStatusClass(project.status, isRunning);
                const statusText = getProjectStatusText(project.status, isRunning);
                
                return `
                    <div class="project-card ${statusClass}">
                        <div class="project-header">
                            <div class="project-title">${project.name}</div>
                            <div class="project-status status-${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="project-info">
                            <p><strong>URL:</strong> <a href="${project.url}" target="_blank" style="color: #2196F3; text-decoration: none;">${project.url}</a></p>
                            <p><strong>√âtape:</strong> ${project.currentStep || 'Non d√©finie'}</p>
                            <p><strong>Derni√®re activit√©:</strong> ${formatDate(project.lastActivity)}</p>
                        </div>
                        
                        <div class="project-actions">
                            ${renderProjectActions(project, isRunning)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getProjectStatusClass(status, isRunning = false) {
            if (isRunning) return 'running';
            switch (status) {
                case 'completed': return 'completed';
                case 'error': return 'error';
                case 'paused': return 'paused';
                default: return 'started';
            }
        }

        function getProjectStatusText(status, isRunning = false) {
            if (isRunning) return 'üîÑ En cours';
            switch (status) {
                case 'completed': return '‚úÖ Termin√©';
                case 'error': return '‚ùå Erreur';
                case 'paused': return '‚è∏Ô∏è Paus√©';
                case 'started': return '‚≠ê D√©marr√©';
                default: return 'üìù Inconnu';
            }
        }

        function renderProjectActions(project, isRunning) {
            if (isRunning) {
                return `
                    <button class="btn btn-secondary btn-small" onclick="viewProjectProgress('${project.name}')">
                        üìä Progression
                    </button>
                    <button class="btn btn-warning btn-small" onclick="pauseProject('${project.name}')">
                        ‚è∏Ô∏è Pause
                    </button>
                `;
            } else {
                return `
                    <button class="btn btn-primary btn-small" onclick="continueProject('${project.name}')">
                        ‚ñ∂Ô∏è Continuer
                    </button>
                    <button class="btn btn-warning btn-small" onclick="showOverwriteForm('${project.name}')">
                        üîÑ √âcraser
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deleteProject('${project.name}')">
                        üóëÔ∏è Supprimer
                    </button>
                `;
            }
        }

        function updateCurrentAgent() {
            const currentAgentDiv = document.getElementById('current-agent');
            
            if (appState.currentAgent && appState.currentAgent.isRunning) {
                currentAgentDiv.classList.remove('hidden');
                document.getElementById('current-project-name').textContent = appState.currentAgent.projectName || '-';
                document.getElementById('current-project-step').textContent = appState.currentAgent.currentStep || '-';
                document.getElementById('current-project-status').textContent = appState.currentAgent.isRunning ? 'üîÑ Actif' : '‚èπÔ∏è Arr√™t√©';
            } else {
                currentAgentDiv.classList.add('hidden');
            }
        }

        function refreshProjects() {
            addLog('üîÑ Actualisation des projets...');
            loadProjects();
        }

        function showNewProjectForm() {
            document.getElementById('projects-management').classList.remove('active');
            document.getElementById('new-project-config').classList.add('active');
            addLog('üìù Formulaire nouveau projet affich√©');
        }

        function continueProject(projectName) {
            if (confirm(`Continuer le projet "${projectName}" ?`)) {
                addLog(`‚ñ∂Ô∏è Continuation du projet ${projectName}...`);
                
                fetch('/api/continue-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Projet "${projectName}" en cours de reprise`, 'success');
                        addLog(`‚úÖ Demande de continuation envoy√©e`);
                        setTimeout(loadProjects, 2000);
                    }
                })
                .catch(error => {
                    showNotification('Erreur lors de la continuation', 'error');
                    addLog(`‚ùå Erreur: ${error.message}`);
                });
            }
        }

        function showOverwriteForm(projectName) {
            const newGithubUrl = prompt(`Nouvelle URL GitHub pour √©craser "${projectName}" :`);
            if (newGithubUrl) {
                if (confirm(`√ätes-vous s√ªr de vouloir √©craser le projet "${projectName}" avec "${newGithubUrl}" ?`)) {
                    overwriteProject(projectName, newGithubUrl);
                }
            }
        }

        function overwriteProject(projectName, newGithubUrl) {
            addLog(`üîÑ √âcrasement du projet ${projectName}...`);
            
            const database = getDatabaseConfig();
            const superAdmin = getAdminConfig();
            
            fetch('/api/overwrite-project', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    projectName,
                    newGithubUrl,
                    database,
                    superAdmin: superAdmin.email ? superAdmin : null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Projet "${projectName}" √©cras√© avec succ√®s`, 'success');
                    addLog(`‚úÖ Projet √©cras√© avec ${newGithubUrl}`);
                    setTimeout(loadProjects, 2000);
                }
            })
            .catch(error => {
                showNotification('Erreur lors de l\'√©crasement', 'error');
                addLog(`‚ùå Erreur: ${error.message}`);
            });
        }

        function deleteProject(projectName) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer d√©finitivement le projet "${projectName}" ?`)) {
                addLog(`üóëÔ∏è Suppression du projet ${projectName}...`);
                
                fetch(`/api/projects/${encodeURIComponent(projectName)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Projet "${projectName}" supprim√©`, 'success');
                        addLog(`‚úÖ Projet supprim√©`);
                        setTimeout(loadProjects, 1000);
                    }
                })
                .catch(error => {
                    showNotification('Erreur lors de la suppression', 'error');
                    addLog(`‚ùå Erreur: ${error.message}`);
                });
            }
        }

        function viewProjectProgress(projectName) {
            switchToProgressView();
            addLog(`üìä Affichage progression du projet ${projectName}`);
        }

        function viewCurrentProgress() {
            if (appState.currentAgent && appState.currentAgent.projectName) {
                viewProjectProgress(appState.currentAgent.projectName);
            }
        }

        function stopCurrentAgent() {
            if (confirm('Arr√™ter l\'agent actuel ?')) {
                addLog('‚èπÔ∏è Arr√™t de l\'agent demand√©...');
                showNotification('Fonctionnalit√© d\'arr√™t en cours d\'impl√©mentation', 'warning');
            }
        }

        function pauseProject(projectName) {
            if (confirm(`Mettre en pause le projet "${projectName}" ?`)) {
                addLog(`‚è∏Ô∏è Pause du projet ${projectName}...`);
                showNotification('Fonctionnalit√© de pause en cours d\'impl√©mentation', 'warning');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Non d√©finie';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR');
        }

        function backToProjectsManagement() {
            // Masquer toutes les sections
            document.querySelectorAll('.config-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la gestion des projets
            document.getElementById('projects-management').classList.add('active');
            
            // Actualiser les projets
            loadProjects();
            addLog('üîô Retour √† la gestion des projets');
        }

        // ===== GESTION SYST√àME & MISES √Ä JOUR =====
        
        function loadSystemConfig() {
            fetch('/api/system-config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.config;
                        document.getElementById('current-port').textContent = config.currentPort;
                        
                        // Mettre √† jour le s√©lecteur de port
                        const portSelector = document.getElementById('port-selector');
                        portSelector.value = config.currentPort;
                        
                        addLog(`‚öôÔ∏è Configuration syst√®me charg√©e (Port: ${config.currentPort})`);
                    }
                })
                .catch(error => {
                    addLog(`‚ùå Erreur chargement config syst√®me: ${error.message}`);
                });
        }

        function checkForUpdates() {
            const checkBtn = document.getElementById('check-update-btn');
            const updateText = document.getElementById('update-text');
            
            checkBtn.disabled = true;
            checkBtn.textContent = 'üîÑ V√©rification...';
            updateText.textContent = 'V√©rification en cours...';
            updateText.className = 'text-info';
            
            fetch('/api/check-updates')
                .then(response => response.json())
                .then(data => {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'üîç V√©rifier';
                    
                    if (data.success) {
                        document.getElementById('current-version').textContent = data.currentVersion;
                        
                        if (data.hasUpdate) {
                            updateText.textContent = `Mise √† jour disponible: v${data.latestVersion}`;
                            updateText.className = 'text-warning';
                            document.getElementById('latest-version').textContent = data.latestVersion;
                            document.getElementById('update-available').classList.remove('hidden');
                            showNotification(`Nouvelle version ${data.latestVersion} disponible !`, 'info');
                            addLog(`üÜï Mise √† jour disponible: v${data.latestVersion}`);
                        } else {
                            updateText.textContent = '√Ä jour';
                            updateText.className = 'text-success';
                            document.getElementById('update-available').classList.add('hidden');
                            addLog('‚úÖ Agent √† jour');
                        }
                    } else {
                        updateText.textContent = 'Erreur v√©rification';
                        updateText.className = 'text-error';
                        addLog(`‚ùå Erreur v√©rification: ${data.error}`);
                    }
                })
                .catch(error => {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'üîç V√©rifier';
                    updateText.textContent = 'Erreur de connexion';
                    updateText.className = 'text-error';
                    addLog(`‚ùå Erreur v√©rification mises √† jour: ${error.message}`);
                });
        }

        function updateAgent() {
            if (!confirm('Mettre √† jour l\'agent Firebase App Builder ?\n\nCela va:\n- D√©sinstaller l\'ancienne version\n- Installer la derni√®re version depuis GitHub\n- Red√©marrer peut √™tre n√©cessaire')) {
                return;
            }
            
            addLog('üöÄ D√©but mise √† jour de l\'agent...');
            showNotification('Mise √† jour en cours...', 'info');
            
            // D√©sactiver le bouton
            const updateBtn = event.target;
            updateBtn.disabled = true;
            updateBtn.textContent = 'üì• Mise √† jour...';
            
            fetch('/api/update-agent', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                updateBtn.disabled = false;
                updateBtn.textContent = 'üì• Mettre √† jour';
                
                if (data.success) {
                    showNotification('Mise √† jour termin√©e avec succ√®s !', 'success');
                    addLog('‚úÖ Mise √† jour termin√©e');
                    
                    // Masquer la notification de mise √† jour
                    document.getElementById('update-available').classList.add('hidden');
                    
                    // Afficher les √©tapes dans les logs
                    if (data.result && data.result.steps) {
                        data.result.steps.forEach(step => addLog(step));
                    }
                    
                    // Rafra√Æchir la v√©rification
                    setTimeout(checkForUpdates, 2000);
                } else {
                    showNotification('Erreur lors de la mise √† jour', 'error');
                    addLog(`‚ùå Erreur mise √† jour: ${data.result?.error || 'Erreur inconnue'}`);
                    
                    if (data.result && data.result.steps) {
                        data.result.steps.forEach(step => addLog(step));
                    }
                }
            })
            .catch(error => {
                updateBtn.disabled = false;
                updateBtn.textContent = 'üì• Mettre √† jour';
                showNotification('Erreur de communication', 'error');
                addLog(`‚ùå Erreur: ${error.message}`);
            });
        }

        function dismissUpdate() {
            document.getElementById('update-available').classList.add('hidden');
            addLog('‚è≠Ô∏è Mise √† jour report√©e');
        }

        function changePort() {
            const newPort = document.getElementById('port-selector').value;
            const currentPort = document.getElementById('current-port').textContent;
            
            if (newPort === currentPort) {
                showNotification('Port identique, aucun changement n√©cessaire', 'info');
                return;
            }
            
            if (confirm(`Changer le port de ${currentPort} vers ${newPort} ?\n\nCela va red√©marrer l'interface web.`)) {
                addLog(`üîÑ Changement de port vers ${newPort}...`);
                
                fetch('/api/change-port', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPort: parseInt(newPort) })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Red√©marrage avec nouveau port...', 'info');
                        addLog(`‚úÖ Red√©marrage sur port ${newPort} demand√©`);
                        
                        // Rediriger vers le nouveau port apr√®s 3 secondes
                        setTimeout(() => {
                            window.location.href = `http://localhost:${newPort}`;
                        }, 3000);
                    } else {
                        showNotification('Erreur changement de port', 'error');
                        addLog(`‚ùå Erreur: ${data.error}`);
                    }
                })
                .catch(error => {
                    showNotification('Erreur de communication', 'error');
                    addLog(`‚ùå Erreur: ${error.message}`);
                });
            }
        }

        function openFolder(type) {
            const folders = {
                'projects': 'C:/Users/util01/firebase-migrations/',
                'agent': 'C:/Users/util01/firebase-app-builder-mcp/',
                'logs': 'C:/Users/util01/firebase-migrations/logs/'
            };
            
            const folderPath = folders[type];
            if (folderPath) {
                addLog(`üìÇ Ouverture dossier: ${folderPath}`);
                showNotification(`Tentative d'ouverture du dossier ${type}`, 'info');
                
                // Pour Windows, on peut essayer d'ouvrir avec explorer
                // Mais depuis le navigateur web, c'est limit√© pour des raisons de s√©curit√©
                // On affiche juste le chemin pour que l'utilisateur puisse le copier
                navigator.clipboard.writeText(folderPath).then(() => {
                    showNotification(`Chemin copi√©: ${folderPath}`, 'success');
                }).catch(() => {
                    showNotification(`Chemin: ${folderPath}`, 'info');
                });
            }
        }

        // Utility Functions
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Auto-refresh status every 10 seconds
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'request-status' }));
            }
        }, 10000);
    </script>
</body>
</html>